!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).Clipic=i()}(this,function(){"use strict";!function(t,i){void 0===i&&(i={});var e=i.insertAt;if(t&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===e&&n.firstChild?n.insertBefore(s,n.firstChild):n.appendChild(s),s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t))}}(".clipic-body{background:#1c1c1c;position:fixed;width:100%;height:100%;top:0;left:0;-webkit-transform:translateY(100%);-ms-transform:translateY(100%);transform:translateY(100%);-webkit-transition:.4s;-o-transition:.4s;transition:.4s;-webkit-touch-callout:none;-webkit-user-select:none;z-index:9999;overflow:hidden}.clipic-body,.clipic-body *{-webkit-box-sizing:border-box;box-sizing:border-box}.clipic-layer{background:rgba(0,0,0,.7);pointer-events:none;transform:translateZ(0)}.clipic-layer__top{height:30px;position:relative;z-index:10}.clipic-layer__center{display:flex;align-items:stretch;justify-content:space-between}.clipic-frame{background:#f2f2f2;position:relative;z-index:1}.clipic-layer__left,.clipic-layer__right{min-width:30px;flex-shrink:1;flex:1;position:relative;z-index:10}.clipic-layer__bottom{height:100%;position:relative;z-index:10}.clipic-operation-bar{display:-webkit-box;display:-ms-flexbox;display:flex;color:#f2f2f2;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;position:absolute;width:100%;bottom:0;left:0;z-index:11}.clipic-operation-bar [role=button]{padding:15px 20px;font-size:1em}.clipic-frame img{-webkit-touch-callout:none;pointer-events:none}.clipic-cancel{color:#e04c4c}.clipic-reset{color:#3680fd}.clipic-confirm{color:#23c667}");return function(){function t(){this.defaults={width:500,height:500,radio:"",src:"",encode:"base64",type:"jpeg",name:"clipic",quality:.9,buttonText:["取消","重置","完成"]},this.createHtml(),this.clipic=this.getId("clipic"),this.img=this.getId("clipicImg"),this.frame=this.getId("clipicFrame"),this.cancelBtn=this.getId("clipicCancel"),this.resetBtn=this.getId("clipicReset"),this.confirmBtn=this.getId("clipicConfirm")}return t.prototype.getId=function(t){return document.getElementById(t)},t.prototype.createHtml=function(){if(!this.getId("clipic")){var t=document.createElement("div");t.className="clipic-body",t.setAttribute("id","clipic"),t.innerHTML='\n    <div class="clipic-layer clipic-layer__top"></div>\n    <div class="clipic-layer__center">\n      <div class="clipic-layer clipic-layer__left"></div>\n      <div class="clipic-frame" id="clipicFrame">\n        <img id="clipicImg" crossOrigin="Anonymous">\n      </div>\n      <div class="clipic-layer clipic-layer__right"></div>\n    </div>\n    <div class="clipic-layer clipic-layer__bottom"></div>\n    <div class="clipic-operation-bar">\n      <div class="clipic-cancel" id="clipicCancel" role="button">取消</div>\n      <div class="clipic-reset" id="clipicReset" role="button">重置</div>\n      <div class="clipic-confirm" id="clipicConfirm" role="button">完成</div>\n    </div>\n  ',document.body.appendChild(t)}},t.prototype.getImage=function(t){var i=this;this.scale=1,this.rotate=0,this.translateX=0,this.translateY=0;var e=JSON.parse(JSON.stringify(this.defaults));this.options=Object.assign(e,t),this.cancelBtn.innerHTML=this.options.buttonText[0],this.resetBtn.innerHTML=this.options.buttonText[1],this.confirmBtn.innerHTML=this.options.buttonText[2],this.img.src=this.options.src;var n=new Image;n.onload=function(){i.originW=i.img.width,i.originH=i.img.height,i.options.ratio?(i.options.width=i.img.width,i.options.height=i.img.width/i.options.ratio):i.options.ratio=i.options.width/i.options.height,i.originRatio=i.originW/i.originH,i.initSize(),i.clipic.style.transform="translate(0, 0)",setTimeout(function(){i.options.ratio>i.originRatio?i.img.style.width=i.frame.clientWidth+"px":i.img.style.height=i.frame.clientHeight+"px"},300),i.setTransform(),i.cancelBtn.addEventListener("click",i.cancel.bind(i)),i.resetBtn.addEventListener("click",i.reset.bind(i)),i.confirmBtn.addEventListener("click",i.done.bind(i)),i.clipic.addEventListener("touchmove",function(t){if(t.preventDefault(),1<t.touches.length)return i.setScale(t.touches[0],t.touches[1]),void i.setRotate(t.touches[0],t.touches[1]);i.setTranslate(t.touches[0])}),i.clipic.addEventListener("touchend",function(t){i.distance=null,i.angle=null,i.moveX=null,i.moveY=null})},n.src=this.options.src},t.prototype.initSize=function(){var t=document.body.clientWidth-60,i=document.body.clientHeight-80;this.frame.style.width=t+"px",this.frame.style.height=t/this.options.ratio+"px",t/this.options.ratio>i&&(this.frame.style.height=i+"px",this.frame.style.width=i*this.options.ratio+"px"),this.options.ratio>this.originRatio?this.img.style.width=this.frame.clientWidth+"px":this.img.style.height=this.frame.clientHeight+"px"},t.prototype.setScale=function(t,i){var e=Math.abs(t.clientX-i.clientX),n=Math.abs(t.clientY-i.clientY),s=Math.sqrt(e*e+n*n);this.distance&&(this.scale+=(s-this.distance)/this.img.clientWidth,this.setTransform()),this.distance=s},t.prototype.setRotate=function(t,i){var e=t.clientX-i.clientX,n=t.clientY-i.clientY,s=180*Math.atan2(n,e)/Math.PI;this.angle&&(this.rotate+=s-this.angle,this.setTransform()),this.angle=s},t.prototype.setTranslate=function(t){var i=t.clientX,e=t.clientY;this.moveX&&(this.translateX+=i-this.moveX),this.moveY&&(this.translateY+=e-this.moveY),this.moveX=i,this.moveY=e,this.setTransform()},t.prototype.setTransform=function(){var t="translate("+this.translateX+"px, "+this.translateY+"px) scale("+this.scale+") rotate("+this.rotate+"deg)";this.img.style.transform=t},t.prototype.cancel=function(t){var i=this;this.clipic.style.transform="translate(0, 100%)",setTimeout(function(){i.img.removeAttribute("style"),i.img.removeAttribute("src")},400),this.options.onCancel&&"done"!==t&&this.options.onCancel(),this.cancelBtn.removeEventListener("click",this.cancel.bind(this)),this.resetBtn.removeEventListener("click",this.reset.bind(this)),this.confirmBtn.removeEventListener("click",this.done.bind(this),!0)},t.prototype.reset=function(){var t=this;this.scale=1,this.rotate=0,this.translateX=0,this.translateY=0,this.img.style.transition="0.3s",this.setTransform(),setTimeout(function(){t.img.style.transition=""},300)},t.prototype.done=function(){var e=this,t=this.options.width/this.frame.clientWidth,i=document.createElement("canvas");i.width=this.options.width,i.height=this.options.height;var n,s,o=i.getContext("2d");o.fillStyle="#fff",o.fillRect(0,0,i.width,i.height),this.options.ratio>this.originRatio?(n=this.options.width,s=this.originH/(this.originW/this.options.width)):(s=this.options.height,n=this.originW/(this.originH/this.options.height));var c={x:n/2,y:s/2};if(o.translate(this.translateX*t,this.translateY*t),0!==this.rotate&&(o.translate(c.x,c.y),o.rotate(this.rotate*Math.PI/180),o.translate(-c.x,-c.y)),1!==this.scale&&(o.translate(c.x*(1-this.scale),c.y*(1-this.scale)),o.scale(this.scale,this.scale)),o.drawImage(this.img,0,0,n,s),this.options.onDone)switch(this.options.encode){case"base64":this.options.onDone(i.toDataURL("image/"+this.options.type,this.options.quality));break;case"blob":i.toBlob(function(t){e.options.onDone(t)},"image/"+this.options.type);break;case"file":i.toBlob(function(t){var i=new window.File([t],e.options.name,{type:"image/"+e.options.type});e.options.onDone(i)},"image/"+this.options.type);break;default:this.options.onDone(i.toDataURL("image/"+this.options.type,this.options.quality))}this.cancel("done")},t}()});

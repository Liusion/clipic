!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(i=i||self).Clipic=t()}(this,function(){"use strict";var i=function(){function n(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}return function(i,t,e){return t&&n(i.prototype,t),e&&n(i,e),i}}();return function(){function t(i){!function(i,t){if(!(i instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=i,this.init(),this.clipicFrame1=this.getId("clipicFrame1"),this.clipicFrame2=this.getId("clipicFrame2"),this.clipicImg1=this.getId("clipicImg1"),this.clipicImg2=this.getId("clipicImg2"),this.clipic=this.getId("clipic"),this.clipicCancel=this.getId("clipicCancel"),this.clipicConfirm=this.getId("clipicConfirm")}return i(t,[{key:"init",value:function(){this.createStyle(),this.createHtml()}},{key:"getId",value:function(i){return document.getElementById(i)}},{key:"createStyle",value:function(){var i=document.createElement("style");i.type="text/css",i.innerHTML='\n.clipic-body {\n  background: #1c1c1c;\n  position: fixed;\n  width: 100%;\n  height: 100%;\n  top: 0;\n  left: 0;\n  -webkit-transform: translate(0, 100%);\n      -ms-transform: translate(0, 100%);\n          transform: translate(0, 100%);\n  -webkit-transition: 0.4s;\n  -o-transition: 0.4s;\n  transition: 0.4s;\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -webkit-box-sizing: border-box;\n          box-sizing: border-box;\n  z-index: 99;\n}\n.clipic-body * {\n  -webkit-box-sizing: border-box;\n          box-sizing: border-box;\n}\n.clipic-operation-bar {\n  display: -webkit-box;\n  display: -ms-flexbox;\n  display: flex;\n  color: #f2f2f2;\n  -webkit-box-pack: justify;\n      -ms-flex-pack: justify;\n          justify-content: space-between;\n  position: absolute;\n  width: 100%;\n  bottom: 0;\n  left: 0;\n}\n.clipic-operation-bar [role="button"] {\n  padding: 15px 20px;\n  font-size: 1em;\n}\n.clipic-frame {\n  width: calc(100% - 60px);\n  height: 300px;\n  margin: 30px;\n  background: #f2f2f2;\n  position: absolute;\n}\n.clipic-frame img {\n  -webkit-touch-callout: none;\n  pointer-events: none;\n  -webkit-filter: blur(2px);\n          filter: blur(2px);\n}\n.clipic-frame-show {\n  overflow: hidden;\n}\n.clipic-frame-show img {\n  -webkit-filter: blur(0);\n          filter: blur(0);\n}\n.clipic-cancel {\n  color: #3680fd;\n}\n.clipic-confirm{\n  color: #23c667;\n}\n.clipic-layer {\n  position: fixed;\n  width: 100%;\n  height: 100%;\n  top: 0;\n  left: 0;\n  background: rgba(0,0,0,0.5);\n  pointer-events: none;\n}\n',document.getElementsByTagName("HEAD").item(0).appendChild(i)}},{key:"createHtml",value:function(){var i=document.createElement("div");i.className="clipic-body",i.setAttribute("id","clipic"),i.innerHTML='\n    <div class="clipic-frame" id="clipicFrame1"><img id="clipicImg1"></div>\n    <div class="clipic-layer"></div>\n    <div class="clipic-frame clipic-frame-show" id="clipicFrame2"><img id="clipicImg2"></div>\n    <div class="clipic-operation-bar">\n      <div class="clipic-cancel" id="clipicCancel" role="button">取消</div>\n      <div class="clipic-confirm" id="clipicConfirm" role="button">完成</div>\n    </div>\n  ',document.body.appendChild(i)}},{key:"getImage",value:function(){var t=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.scale=1,this.rotate=0,this.translateX=0,this.translateY=0,this.touchStartTime=0,this.touchEndTime=0,this.touchStartX=0,this.touchStartY=0,this.touchEndX=0,this.touchEndY=0,this.scrollX=0,this.scrollY=0,this.scrollTimes=[],this.newOptions=Object.assign(this.options||{},i),this.newOptions.ratio=this.newOptions.ratio||this.newOptions.width/this.newOptions.height,this.clipicFrame2.style.height=this.clipicFrame2.clientWidth/this.newOptions.ratio+"px",this.clipicImg1.src=this.newOptions.src,this.clipicImg2.src=this.newOptions.src,this.clipicImg2.onload=function(){t.originW=t.clipicImg2.width,t.originH=t.clipicImg2.height,t.originRatio=t.originW/t.originH,t.initSize(),t.clipic.style.transform="translate(0, 0)",t.clipicCancel.addEventListener("click",function(){t.cancel()}),t.clipicConfirm.addEventListener("click",function(){t.done()}),t.clipicFrame2.addEventListener("dblclick",function(){console.log(t.scale)}),t.clipicFrame2.addEventListener("touchstart",function(i){t.touchStartX=i.touches[0].clientX,t.touchStartY=i.touches[0].clientY,clearTimeout(t.ST)}),t.clipicFrame2.addEventListener("touchmove",function(i){if(t.scrollTimes.push(i.timeStamp),1<i.touches.length)return t.setScale(i.touches[0],i.touches[1]),void t.setRotate(i.touches[0],i.touches[1]);t.setTranslate(i.touches[0]),t.scrollX=i.touches[0].clientX-t.touchStartX,t.scrollY=i.touches[0].clientY-t.touchStartY,t.touchStartTime=Date.now(),t.touchStartX=i.touches[0].clientX,t.touchStartY=i.touches[0].clientY}),t.clipicFrame2.addEventListener("touchend",function(i){t.distance=null,t.angle=null,t.moveX=null,t.moveY=null,t.touchEndTime=Date.now(),t.scrollTimes.push(i.timeStamp)})}}},{key:"initSize",value:function(){this.newOptions.ratio>this.originRatio?(this.clipicImg1.style.width=this.clipicFrame2.clientWidth+"px",this.clipicImg2.style.width=this.clipicFrame2.clientWidth+"px"):(this.clipicImg1.style.height=this.clipicFrame2.clientHeight+"px",this.clipicImg2.style.height=this.clipicFrame2.clientHeight+"px")}},{key:"setScale",value:function(i,t){var e=Math.abs(i.clientX-t.clientX),n=Math.abs(i.clientY-t.clientY),c=Math.sqrt(e*e+n*n);this.distance&&(this.scale+=(c-this.distance)/this.clipicImg2.clientWidth,this.setTransform()),this.distance=c}},{key:"setRotate",value:function(i,t){var e=i.clientX-t.clientX,n=i.clientY-t.clientY,c=180*Math.atan2(n,e)/Math.PI;this.angle&&(this.rotate+=c-this.angle,this.setTransform()),this.angle=c}},{key:"setTranslate",value:function(i){var t=i.clientX,e=i.clientY;this.moveX&&(this.translateX+=t-this.moveX),this.moveY&&(this.translateY+=e-this.moveY),this.moveX=t,this.moveY=e,this.setTransform()}},{key:"setTransform",value:function(){var i="translate("+this.translateX+"px, "+this.translateY+"px) scale("+this.scale+") rotate("+this.rotate+"deg)";this.clipicImg1.style.transform=i,this.clipicImg2.style.transform=i}},{key:"cancel",value:function(){var i=this;this.clipic.style.transform="translate(0, 100%)",setTimeout(function(){i.clipicImg1.style="",i.clipicImg1.src="",i.clipicImg2.style="",i.clipicImg2.src=""},400)}},{key:"done",value:function(){var i=this.newOptions.width/this.clipicFrame2.clientWidth,t=document.createElement("canvas");t.width=this.newOptions.width,t.height=this.newOptions.height;var e=t.getContext("2d");e.fillStyle="#fff",e.fillRect(0,0,t.width,t.height);var n=void 0,c=void 0;this.newOptions.ratio>this.originRatio?(n=this.newOptions.width,c=this.originH/(this.originW/this.newOptions.width)):(c=this.newOptions.height,n=this.originW/(this.originH/this.newOptions.height));var s={x:n/2,y:c/2};e.translate(this.translateX*i,this.translateY*i),0!==this.rotate&&(e.translate(s.x,s.y),e.rotate(this.rotate*Math.PI/180),e.translate(-s.x,-s.y)),0!==this.scale&&(e.translate(s.x*(1-this.scale),s.y*(1-this.scale)),e.scale(this.scale,this.scale)),e.drawImage(this.clipicImg2,0,0,n,c),this.newOptions.onDone(t.toDataURL("image/jpeg",.8)),this.cancel()}}]),t}()});
